{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="card">
        <div class="card-header text-center">
            <h2>Duel</h2>
        </div>
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-6">
                    <h3>{{ duel.challenger.username }}</h3>
                    <p>HP: <span id="challenger_hp" class="badge bg-success">{{ duel.challenger_health }}</span></p>
                </div>
                <div class="col-md-6">
                    <h3>{{ duel.opponent.username }}</h3>
                    <p>HP: <span id="opponent_hp" class="badge bg-success">{{ duel.opponent_health }}</span></p>
                </div>
            </div>

            <div id="duel_active_section" style="display: {% if duel.status != 'accepted' %}none{% else %}block{% endif %};" class="text-center mt-4">
                <p id="turn_text" class="lead">Current Turn: {{ duel.current_turn.username }}</p>
                <p id="last_spell_info" class="text-muted">{% if duel.last_spell_cast %}Last Attack: {{ duel.last_spell_cast }}{% endif %}{% if duel.last_defender_spell %} | Last Defense: {{ duel.last_defender_spell }}{% endif %}</p>

                <form id="spell_form" method="post" action="{% url 'attack' duel.id %}" style="display: {% if duel.current_turn != user %}none{% else %}block{% endif %};">
                    {% csrf_token %}
                    <div class="input-group mb-3">
                        <input type="text" name="spell" id="spell_input" class="form-control" placeholder="Enter your spell...">
                        <button type="submit" class="btn btn-danger">Cast Spell</button>
                    </div>
                </form>

                <p id="waiting_message" style="display: {% if duel.current_turn == user %}none{% else %}block{% endif %};">Waiting for opponent...</p>
            </div>

            <div id="duel_ended_section" style="display: {% if duel.status != 'finished' %}none{% else %}block{% endif %};" class="text-center mt-4">
                <h3>üèÜ Winner: <span id="winner_username">{{ duel.winner.username }}</span></h3>
            </div>

            <div id="end_duel_section" class="text-center mt-4" style="display: {% if duel.status == 'accepted' %}block{% else %}none{% endif %};">  
                <form action="{% url 'end_duel' duel.id %}" method="post">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-warning">End Duel</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
const duelId = {{ duel.id }};
const currentUser = "{{ user.username }}";
const SPELL_DATA = JSON.parse('{{ spell_data_json|escapejs }}');
let pollingInterval;

const spellInput = document.getElementById('spell_input');
const spellSuggestions = document.createElement('div');
spellSuggestions.id = 'spell_suggestions';
spellSuggestions.className = 'list-group';
spellInput.parentNode.insertBefore(spellSuggestions, spellInput.nextSibling);

spellInput.addEventListener('input', () => {
    const query = spellInput.value.toLowerCase();
    spellSuggestions.innerHTML = '';

    if (query.length === 0) {
        return;
    }

    const matchingSpells = Object.keys(SPELL_DATA).filter(spell => 
        spell.toLowerCase().startsWith(query)
    );

    matchingSpells.forEach(spell => {
        const suggestionItem = document.createElement('button');
        suggestionItem.type = 'button';
        suggestionItem.className = 'list-group-item list-group-item-action';
        suggestionItem.innerText = spell;
        suggestionItem.addEventListener('click', () => {
            spellInput.value = spell;
            spellSuggestions.innerHTML = ''; // Clear suggestions
        });
        spellSuggestions.appendChild(suggestionItem);
    });
});

// Clear suggestions when input loses focus (with a slight delay to allow click on suggestion)
spellInput.addEventListener('blur', () => {
    setTimeout(() => {
        spellSuggestions.innerHTML = '';
    }, 100);
});

function checkDuel() {
    fetch(`/duel/${duelId}/status/`)
    .then(res => res.json())
    .then(data => {
        console.log('Duel Status:', data.status);
        // Update health
        document.getElementById('challenger_hp').innerText = data.challenger_health;
        document.getElementById('opponent_hp').innerText = data.opponent_health;

        // Update last spell info
        const lastSpellInfo = document.getElementById('last_spell_info');
        if (lastSpellInfo) {
            let infoText = '';
            if (data.last_spell_cast) {
                infoText += `Last Attack: ${data.last_spell_cast}`;
            }
            if (data.last_defender_spell) {
                infoText += `${data.last_spell_cast ? ' | ' : ''}Last Defense: ${data.last_defender_spell}`;
            }
            lastSpellInfo.innerText = infoText;
        }

        if (data.status === 'accepted') {
            // Update current turn
            document.getElementById('turn_text').innerText = "Current Turn: " + data.current_turn;

            // Toggle form and waiting message
            if (data.current_turn === currentUser) {
                document.getElementById('spell_form').style.display = 'block';
                document.getElementById('waiting_message').style.display = 'none';
            } else {
                document.getElementById('spell_form').style.display = 'none';
                document.getElementById('waiting_message').style.display = 'block';
            }
        } else if (data.status === 'finished') {
            // Duel ended
            document.getElementById('duel_active_section').style.display = 'none';
            document.getElementById('winner_username').innerText = data.winner;
            document.getElementById('duel_ended_section').style.display = 'block';
            const endDuelSection = document.getElementById('end_duel_section');
            if (endDuelSection) {
                endDuelSection.style.display = 'none';
            }
            if (pollingInterval) {
                clearInterval(pollingInterval); // Stop polling
            }
        } else if (data.status === 'cancelled') {
            const endDuelSection = document.getElementById('end_duel_section');
            if (endDuelSection) {
                endDuelSection.style.display = 'none';
            }
            window.location.href = `/duel/${duelId}/cancelled/`;
        }
    })
    .catch(err => {
        console.error('Error fetching duel status:', err);
        if (pollingInterval) {
            clearInterval(pollingInterval); // Stop polling on error
        }
    });
}

// Poll every 2 seconds
if (document.getElementById('duel_active_section').style.display === 'block') {
    pollingInterval = setInterval(checkDuel, 2000);
}
</script>
{% endblock %}
