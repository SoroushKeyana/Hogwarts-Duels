{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="card">
        <div class="card-header text-center">
            <h2>Duel</h2>
        </div>
        <div class="card-body">
            <div class="row text-center">
                <div class="col-md-6">
                    <h3>{{ duel.challenger.username }}</h3>
                    <p>HP: <span id="challenger_hp" class="badge bg-success">{{ duel.challenger_health }}</span></p>
                </div>
                <div class="col-md-6">
                    <h3>{{ duel.opponent.username }}</h3>
                    <p>HP: <span id="opponent_hp" class="badge bg-success">{{ duel.opponent_health }}</span></p>
                </div>
            </div>

            <div id="duel_active_section" style="display: {% if duel.status != 'accepted' %}none{% else %}block{% endif %};" class="text-center mt-4">
                <p id="turn_text" class="lead">Current Turn: {{ duel.current_turn.username }}</p>

                <form id="spell_form" method="post" action="{% url 'attack' duel.id %}" style="display: {% if duel.current_turn != user %}none{% else %}block{% endif %};">
                    {% csrf_token %}
                    <div class="input-group mb-3">
                        <select name="spell" class="form-select">
                            <option value="Stupefy">Stupefy (-3)</option>
                            <option value="Expelliarmus">Expelliarmus (-2)</option>
                            <option value="Sectumsempra">Sectumsempra (-4)</option>
                        </select>
                        <button type="submit" class="btn btn-danger">Cast Spell</button>
                    </div>
                </form>

                <p id="waiting_message" style="display: {% if duel.current_turn == user %}none{% else %}block{% endif %};">Waiting for opponent...</p>
            </div>

            <div id="duel_ended_section" style="display: {% if duel.status != 'finished' %}none{% else %}block{% endif %};" class="text-center mt-4">
                <h3>üèÜ Winner: <span id="winner_username">{{ duel.winner.username }}</span></h3>
            </div>
        </div>
    </div>
</div>

<script>
const duelId = {{ duel.id }};
const currentUser = "{{ user.username }}";
let pollingInterval;

function checkDuel() {
    fetch(`/duel/${duelId}/status/`)
    .then(res => res.json())
    .then(data => {
        // Update health
        document.getElementById('challenger_hp').innerText = data.challenger_health;
        document.getElementById('opponent_hp').innerText = data.opponent_health;

        if (data.status === 'accepted') {
            // Update current turn
            document.getElementById('turn_text').innerText = "Current Turn: " + data.current_turn;

            // Toggle form and waiting message
            if (data.current_turn === currentUser) {
                document.getElementById('spell_form').style.display = 'block';
                document.getElementById('waiting_message').style.display = 'none';
            } else {
                document.getElementById('spell_form').style.display = 'none';
                document.getElementById('waiting_message').style.display = 'block';
            }
        } else if (data.status === 'finished') {
            // Duel ended
            document.getElementById('duel_active_section').style.display = 'none';
            document.getElementById('winner_username').innerText = data.winner;
            document.getElementById('duel_ended_section').style.display = 'block';
            if (pollingInterval) {
                clearInterval(pollingInterval); // Stop polling
            }
        }
    })
    .catch(err => {
        console.error('Error fetching duel status:', err);
        if (pollingInterval) {
            clearInterval(pollingInterval); // Stop polling on error
        }
    });
}

// Poll every 2 seconds
if (document.getElementById('duel_active_section').style.display === 'block') {
    pollingInterval = setInterval(checkDuel, 2000);
}
</script>
{% endblock %}
